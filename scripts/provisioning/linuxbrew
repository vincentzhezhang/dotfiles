#! /usr/bin/env bash

set -eu

source ../../config/bash/bash.env
source ../utils.sh

__.log_info "Using prefix: ${__prefix_linuxbrew:?}"

main() {
  install_linuxbrew
  install_linuxbrew_apps
}

install_linuxbrew(){
  if hash brew 2>/dev/null; then
    __.log_info 'Linuxbrew is installed, skipping...'
    brew --version

    set +u # some path brew want to update may not be defined yet
    brew_envs=$("$__prefix_linuxbrew/bin/brew" shellenv)
    eval "$brew_envs"
    set -u
    echo '--------'
    env | grep -i brew | sort -i
    echo '--------'

    return 0
  fi

  __.log_info 'Installing linuxbrew...'
  getent group linuxbrew || sudo groupadd linuxbrew
  sudo usermod --append --groups linuxbrew "$USER"
  __.log_info "Added $USER to linuxbrew group, you need to logout and log in again to make it work."

  sudo mkdir --parents "$__prefix_linuxbrew"
  sudo chown --recursive "$(whoami):linuxbrew" "$__prefix_linuxbrew"

  git clone --quiet --depth 1 https://github.com/Homebrew/brew "$__prefix_linuxbrew"
  $(
    cd "$__prefix_linuxbrew"
    sudo mkdir --parents \
      Cellar \
      etc \
      include \
      lib \
      opt \
      sbin \
      share \
      var/homebrew/linked
    sudo chmod --recursive ug+rwx \
      Cellar \
      etc \
      include \
      lib \
      opt \
      sbin \
      share \
      var/homebrew/linked
  )
  sudo chown --recursive "$(whoami):linuxbrew" $__prefix_linuxbrew

  __.log_info 'Configuring linuxbrew...'

  set +u # some path brew want to update may not be defined yet
  brew_envs=$("$__prefix_linuxbrew/bin/brew" shellenv)
  eval "$brew_envs"
  set -u
  echo '--------'
  env | grep -i brew | sort
  echo '--------'

  brew --version
}

install_linuxbrew_apps(){
  #
  # Ulilities
  #

  # better alternative to find
  brew install fd
  # better alternative to grep
  brew install ag
  # another better alternative to grep
  brew install rg
  # newer than system git
  brew install git
  # newer than system tmux
  brew install tmux

  # TODO
  # - find a better way to handle pre/post install
  if [[ -d ~/.tmux/plugins/tpm ]]; then
    git -C ~/.tmux/plugins/tpm pull
  else
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
  fi

  __.log_warning 'TODO: install more linuxbrew apps!'
  return 0

  # open source alternative to the Cisco AnyConnect Client
  # XXX the source repo:
  # http://git.infradead.org/users/dwmw2/
  # may be down at times and brew install will stuck
  # TODO
  # - sounds like they moved the official repo to gitlab
  #   then don't we just use source code from there? Maybe worth firing a PR
  brew install openconnect

  #
  # brew installs
  #

  # better alternative for curl
  brew install httpie
  # handy spark lines
  brew install spark
  # YGNI
  brew install youtube-dl
  # JSON for cli
  brew install jq
  # website pressure test (better than ab)
  brew install wrk

  #
  # linters
  #

  # TODO
  # - just throwing thought here, apps should really be defined under categories with name and source
  #   then be consumed by installer
  declare -A linters
  # could just refer to the ale's supported-tools doc for a comprehensive curated list

  # docker file linter
  brew install hadolint

  brew install yamllint

  # FIXME shellcheck, no ideal way to install on a restricted machine yet
  # shell linter
  brew install shellcheck
}

main

# vim: set autoindent expandtab number textwidth=119 tabstop=2 shiftwidth=2 :
