#! /usr/bin/env bash

#
# Misc add-ons
#

__.venv.python.prefix()
{
  # main interface handling various Python virtual envs
  # Priority
  # - [ ] Python specified in the shebang line
  # - [ ] Active conda environment
  # - [ ] Detected conda environment
  # - [ ] Whatever python available in path (maybe 2/3 detection?)
  #
  # TODO may need to rethink about the rationale of the priorities
  #
  # args:
  # - str: path [optional] path to file/directory, default: pwd
  #
  # output:
  # - str: path, path to detected python interpreter w w/o virtual env

  local path
  path=${1:-$PWD}

  local py_exec

  if [[ -f "$path" ]]; then
    # shebang detection
    local shebang_line;
    shebang_line=$(head -1 "$path")

    # XXX need to exclude /usr/bin/env python
    if [[ "$shebang_line" =~ ^#\!.+/python[23]?$ ]]; then
      py_exec=$(cut -c 3- <<< "$shebang_line")
      >&2 echo 'got python from shebang_line!'
      echo -n "$py_exec"
      return 0
    fi
  fi

  if hash __.conda.clever_prefix; then
    py_exec=$(__.conda.clever_prefix "$path")
    >&2 echo 'got python from __.conda.clever_prefix!'
    echo -n "$py_exec"
    return 0
  fi
}


#
# Share contrast across applications
#
# TODO use new system wide contrast settings to deprecate cli app detections
# 0. Terminal color schemes
#   - adaptive color scheme for gnome-terminal
#
# 1. Vim specific settings
#   - vim adaptive color scheme DONE
#   - airline adaptive color scheme
#   - vim gutter related adaptive color scheme
#   - fzf adaptive color scheme
#
# 2. Tmux
#   - tmux adaptive color scheme for status line
get_luminance() {
  # feel free to overwrite luminance in places with consistently
  # lighting, e.g. office
  local luminance="$LUMINANCE_OVERRIDE"

  if [[ -z "$luminance" ]]; then
    local day=530
    local night=1830
    local owl=2359
    time="$(date +%H%M)"

    if ((day <= time && time < night)); then
      luminance='high'
    elif ((night <= time && time < owl)); then
      luminance='normal'
    else
      luminance='low'
    fi
  fi

  echo -n "$luminance"
}


# uncategorized addons go here

if hash brew > /dev/null 2>&1; then
  # generated by brew shellenv, hardcoded here for speedup
  export HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"
  export HOMEBREW_CELLAR="/home/linuxbrew/.linuxbrew/Cellar"
  export HOMEBREW_REPOSITORY="/home/linuxbrew/.linuxbrew"
  export MANPATH="/home/linuxbrew/.linuxbrew/share/man:$MANPATH"
  export INFOPATH="/home/linuxbrew/.linuxbrew/share/info:$INFOPATH"

  if [[ -d "$HOMEBREW_PREFIX/etc/bash_completion.d/" ]]; then
    for comp_file in "$HOMEBREW_PREFIX/etc/bash_completion.d/"*; do
      source "$comp_file"
    done
  fi
fi

####################
# fzf tweaks start #
####################
if hash fzf > /dev/null 2>&1; then
  read -r -d '' FZF_DEFAULT_COMMAND <<BASH
    ($GIT_DEFAULT_LS_COMMAND ||
     find . -path "*/\.*" -prune -o -type f -print -o -type l -print |
        sed s/^..//) 2> /dev/null
BASH
  export FZF_DEFAULT_COMMAND

  # let __fzf_cd__ ignore node_modules and static directories
  read -r -d '' FZF_ALT_C_COMMAND <<BASH
  command find -L . -mindepth 1 \
    \\(\
      -path '*/\\.*' -o \
      -path '*/node_modules' -o \
      -path '*/static' -o \
      -fstype 'sysfs' -o \
      -fstype 'devfs' -o \
      -fstype 'devtmpfs' -o \
      -fstype 'proc' \
    \\) -prune -o -type d -print 2> /dev/null | sed 's/^.\///'
BASH
  export FZF_ALT_C_COMMAND

  # let __fzf_select__ ignore node_modules and static directories
  # TODO
  # - determine symbolic link type and add trailing slash if applicable
  read -r -d '' FZF_CTRL_T_COMMAND <<BASH
    ($GIT_DEFAULT_LS_COMMAND ||
      command find -L . -mindepth 1 \
        \\(\
            -path '*/\\.*' -o \
            -path '*/node_modules' -o \
            -path '*/static' -o \
            -fstype 'sysfs' -o \
            -fstype 'devfs' -o \
            -fstype 'devtmpfs' -o \
            -fstype 'proc' \
        \\) -prune -o \
        -type f -print -o \
        -type d -printf '%p/\n' -o \
        -type l -print \
    ) 2> /dev/null | sed 's/^.\///'
BASH
  export FZF_CTRL_T_COMMAND
fi
####################
#  fzf tweaks end  #
####################
