#! /usr/bin/env bash

# TODO this is just a temporary solution that sufficient enough for current works, should add
# - node/npm version detection
# - ruby version detection
v_env_conda() {
  if [ -z "$CONDA_DEFAULT_ENV" ]; then
    exit 0
  fi

  CONDA_PYTHON_VERSION=$(python -V | cut -d ' ' -f2)

  echo -n "\\[\\e[07;32;2;64m\\]"
  echo -n "$CONDA_DEFAULT_ENV"
  echo -n "|"
  echo -n "${CONDA_PYTHON_VERSION:-unknown}"
  echo -n "\\[\\e[0m\\]"
}

# FIXME length calculation of full-width character is broken
prettify_prompt() {
    # show last command execution result intuitively
    if [[ $? == 0 ]]; then
        last_state=$([[ $OSTYPE == darwin* ]] && echo 'ðŸ˜ƒ ' || echo "${BGREEN}:) ${COFF}")
    else
        last_state=$([[ $OSTYPE == darwin* ]] && echo 'ðŸ˜¡ ' || echo "${BRED}:( ${COFF}")
    fi

    # create a dash line which has a length of the current terminal columns minus
    # user@hostname, time string and padding spaces
    local time_str=''
    local dash_line=''
    local dash_line_padding=2 # spaces before and after the dash line
    local dash_line_width=0

    pwd_str=$(readlink -f "$PWD")
    time_str="$(date +'%H:%M:%S')"

    dash_line_width=$((COLUMNS - ${#pwd_str} - ${#time_str} - dash_line_padding))

    while [[ $dash_line_width -gt 0 ]]
    do
        dash_line="-${dash_line}"
        ((dash_line_width-=1))
    done

    local indicator="${BASE0}~>${COFF} "

    git_str="$(git_prompt)"
    v_env_str="$(v_env_conda)"

    status_line="${BASE00}${pwd_str} ${dash_line} ${time_str}${COFF}"
    old_ps1="${last_state}${git_str}${v_env_str}${indicator}"

    PS1="$status_line\\n$old_ps1"
}

PROMPT_COMMAND="prettify_prompt; $PROMPT_COMMAND"
